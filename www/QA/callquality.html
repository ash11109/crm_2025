<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sales Call Analyzer</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 30px;
      background: #f4f6f8;
      color: #212529;
    }

    h1 {
      font-size: 32px;
      margin-bottom: 20px;
      color: #333;
    }

    input,
    button {
      padding: 12px 16px;
      margin: 10px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline: none;
      transition: all 0.2s ease;
    }

    input:focus,
    button:hover {
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
    }

    .url-input-container {
      margin: 0 0;
      display: none;
    }

    .url-input {
      visibility: hidden;
      width: 100%;
      max-width: 600px;
      padding: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 15px;
      position: absolute;
      top: 0;
      z-index: -100;
    }

    .url-info {
      margin-top: 12px;
      padding: 12px;
      background: #eef2f5;
      border-radius: 6px;
      font-size: 14px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid #ccc;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .results-table th {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 16px;
    }

    .results-table td {
      padding: 16px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    .results-table tr:last-child td {
      border-bottom: none;
    }

    .results-table tr:nth-child(even) {
      background: #f8f9fa;
      background: rgba(0, 123, 255, 0.05);
    }

    .category-cell {
      font-weight: 600;
      color: #333;
      width: 200px;
    }

    .score-cell {
      font-weight: 700;
      font-size: 18px;
      color: #007bff;
      text-align: center;
      width: 100px;
    }

    .comment-cell {
      color: #555;
      line-height: 1.5;
    }

    .detailed-analysis {
      margin-top: 10px;
    }

    .analysis-section {
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      border-radius: 4px;
    }

    .analysis-section h4 {
      margin: 0 0 8px 0;
      color: #007bff;
      font-size: 14px;
      font-weight: 600;
    }

    .analysis-content {
      font-size: 13px;
      line-height: 1.4;
    }

    .original-text {
      background: #ffe6e6;
      padding: 5px 8px;
      border-radius: 3px;
      margin: 5px 0;
      font-style: italic;
    }

    .issue-text {
      background: #fff3cd;
      padding: 5px 8px;
      border-radius: 3px;
      margin: 5px 0;
    }

    .suggestion-text {
      background: #d4edda;
      padding: 5px 8px;
      border-radius: 3px;
      margin: 5px 0;
    }

    .score-high {
      color: #28a745;
    }

    .score-medium {
      color: #ffc107;
    }

    .score-low {
      color: #dc3545;
    }

    #overall {
      font-weight: 600;
      font-size: 22px;
      margin: 24px 0 12px;
      color: #007bff;
    }

    #results {
      margin-top: 40px;
    }

    .error,
    .success,
    .debug,
    .auto-detected {
      padding: 12px 16px;
      border-radius: 6px;
      margin: 12px 0;
      font-size: 14px;
      line-height: 1.5;
    }

    .error {
      color: #721c24;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
    }

    .success {
      color: #155724;
      background: #d4edda;
      border: 1px solid #c3e6cb;
    }

    .debug {
      background: #f1f3f5;
      border: 1px solid #ced4da;
      font-family: monospace;
      font-size: 13px;
      max-height: 250px;
      overflow-y: auto;
    }

    .auto-detected {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
  </style>
</head>
<body>

  <h1>Sales Call Analyzer</h1>
  <p>Enter an audio URL or use the URL parameter to analyze speaker performance using AI.</p>
  
  <div class="url-input-container">
    <input type="url" id="urlInput" class="url-input" placeholder="Enter audio file URL here..." />
    <div id="urlInfo" class="url-info" style="display: none;"></div>
  </div>
  
  <button id="analyzeBtn" disabled>Analyze</button>

  <div id="spinner" class="spinner" style="display: none;"></div>
  <div id="status"></div>
  <div id="errorMessage" class="error" style="display: none;"></div>
  

  <div id="results" style="display: none;">
    <div id="overall"></div>
    <div id="scoreCards"></div>
    <button id="resetBtn">Analyze Another Call</button>
  </div>

  <div id="debugInfo" class="debug" style="display: none;"></div>

  <script>
    const TRANSCRIBE_URL = 'https://sttsarvam.onrender.com/transcribe/urls';
    const GEMINI_API_KEY = 'AIzaSyBDHAtCgKffA2YurDUpwkH-Nvr19HJF3DQ';
    const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
    const CHECK_DB_URL = 'https://teamka.in/z_ash_test/fetch_status.php';
    const SAVE_DB_URL = 'https://teamka.in/z_ash_test/save_qa.php';

    const urlInput = document.getElementById('urlInput');
    const urlInfo = document.getElementById('urlInfo');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const spinner = document.getElementById('spinner');
    const status = document.getElementById('status');
    const errorMessage = document.getElementById('errorMessage');
    const debugInfo = document.getElementById('debugInfo');
    const results = document.getElementById('results');
    const overall = document.getElementById('overall');
    const scoreCards = document.getElementById('scoreCards');
    const resetBtn = document.getElementById('resetBtn');

    // Check for audiolink parameter in URL
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Initialize with URL parameter or localStorage if present
    window.addEventListener('load', function() {
      let audiolink = getUrlParameter('audiolink');
      let type = getUrlParameter('type');
      let id = getUrlParameter('id');
      let source = 'URL parameter';
      
      // Fallback to localStorage if no URL parameter
      if (!audiolink && window.localStorage && localStorage.getItem('AI_QA_link')) {
        audiolink = localStorage.getItem('AI_QA_link');
        type = localStorage.getItem('AI_QA_Intrested_IN');
        id = localStorage.getItem('AI_QA_CS_ID');
        source = 'localStorage';
      }
      
      if (audiolink) {
        urlInput.value = audiolink;
        
        let infoHtml = `
          <strong>Auto-detected URL:</strong> ${audiolink}<br>
          <strong>Source:</strong> ${source}
        `;
        
        if (type) infoHtml += `<br><strong>Type:</strong> ${type}`;
        if (id) infoHtml += `<br><strong>ID:</strong> ${id}`;
        
        urlInfo.innerHTML = infoHtml;
        urlInfo.className = 'url-info auto-detected';
        urlInfo.style.display = 'block';
        analyzeBtn.disabled = false;
        
        // Store these values for later use in analysis
        window.qaData = { audiolink, type, id };
        
        // Auto-click the analyze button after a short delay
        setTimeout(() => {
          analyzeBtn.click();
        }, 500);

        setTimeout(() => {
          analyzeBtn.disabled = true;
          analyzeBtn.textContent = 'Analyzing...';
        }, 600)
      }
    });

    // URL input handler
    urlInput.addEventListener('input', function(e) {
      const url = e.target.value.trim();
      if (url && isValidUrl(url)) {
        urlInfo.innerHTML = `
          <strong>Audio URL:</strong> ${url}<br>
          <strong>Status:</strong> Ready to analyze
        `;
        urlInfo.className = 'url-info';
        urlInfo.style.display = 'block';
        analyzeBtn.disabled = false;
      } else if (url) {
        urlInfo.innerHTML = `
          <strong>Invalid URL:</strong> Please enter a valid audio file URL
        `;
        urlInfo.className = 'url-info error';
        urlInfo.style.display = 'block';
        analyzeBtn.disabled = true;
      } else {
        urlInfo.style.display = 'none';
        analyzeBtn.disabled = true;
      }
    });

    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      spinner.style.display = 'none';
      status.textContent = '';
    }

    function showDebug(info) {
      debugInfo.textContent = JSON.stringify(info, null, 2);
      debugInfo.style.display = 'block';
    }

    function hideError() {
      errorMessage.style.display = 'none';
      debugInfo.style.display = 'none';
    }

    // Function to parse database records with detailed analysis
    function parseDetailedAnalysis(jsonString) {
      try {
        const obj = JSON.parse(jsonString);
        if (typeof obj === 'object' && obj !== null) {
          // Handle both old format (simple) and new format (detailed)
          if ('score' in obj && 'comment' in obj && !('detailed_analysis' in obj)) {
            // Old format - convert to new format
            return {
              score: obj.score || 0,
              comment: obj.comment || 'No comment',
              detailed_analysis: []
            };
          } else if ('score' in obj && 'detailed_analysis' in obj) {
            // New detailed format
            return obj;
          }
        }
        return { score: 0, comment: 'Invalid format', detailed_analysis: [] };
      } catch {
        return { score: 0, comment: 'Not JSON', detailed_analysis: [] };
      }
    }

    analyzeBtn.onclick = async () => {
      const audioUrl = urlInput.value.trim();
      if (!audioUrl || !isValidUrl(audioUrl)) {
        showError('Please enter a valid audio URL first.');
        return;
      }

      hideError();
      spinner.style.display = 'block';
      status.textContent = 'Checking database for existing analysis...';
      results.style.display = 'none';

      try {
        // First, check if analysis already exists in database
        const checkRes = await fetch(`${CHECK_DB_URL}?audiolink=${encodeURIComponent(audioUrl)}`);

        if (!checkRes.ok) {
            throw new Error(`Database check failed: ${checkRes.status}`);
        }

        const checkData = await checkRes.text();
        console.log('Database check response:', checkData);

        // Parse the response
        let parsedResponse;
        try {
            parsedResponse = JSON.parse(checkData);
        } catch (e) {
            throw new Error('Invalid response from database check');
        }

        // Handle different response types
        if (parsedResponse === "NOT_FOUND") {
            // No record in DB — proceed with transcription + analysis
            console.log('No record found in DB, proceeding with transcription...');
            status.textContent = 'No existing analysis found. Starting transcription...';
        } else if (parsedResponse === "PENDING") {
            // Record exists but is pending — proceed with transcription + analysis
            console.log('Record is pending, proceeding with transcription...');
            status.textContent = 'Found pending record. Starting transcription...';
        } else if (Array.isArray(parsedResponse) && parsedResponse.length > 0) {
            // We have existing completed data, use it
            status.textContent = 'Found existing analysis in database!';
            const dbRecord = parsedResponse[0];
            
            const analysisData = {
                engagement: parseDetailedAnalysis(dbRecord.Call_Opening),
                clarity: parseDetailedAnalysis(dbRecord.Speech_Clarity),
                product_knowledge: parseDetailedAnalysis(dbRecord.Product_Knowledge),
                listening_skills: parseDetailedAnalysis(dbRecord.Call_Control),
                handling_objections: parseDetailedAnalysis(dbRecord.Communication_Skill),
                closing_techniques: parseDetailedAnalysis(dbRecord.Closing_Skill)
            };
            
            showResults(analysisData);
            return;
        } else {
            throw new Error('Unexpected response format from database');
        }

        // No existing data, proceed with API calls
        status.textContent = 'No existing analysis found. Starting transcription...';
        
        // Send URL to transcription service
        const requestBody = {
          file_urls: [audioUrl]
        };

        console.log('Sending to:', TRANSCRIBE_URL);
        console.log('Request body:', requestBody);

        const transcribeRes = await fetch(TRANSCRIBE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        console.log('Response status:', transcribeRes.status);
        
        if (!transcribeRes.ok) {
          const errorText = await transcribeRes.text();
          console.error('Error response:', errorText);
          throw new Error(`Server error ${transcribeRes.status}: ${errorText}`);
        }

        status.textContent = 'Processing transcription...';
        const transcribeData = await transcribeRes.json();
        console.log('Transcription response:', transcribeData);
        showDebug(transcribeData);

        // Extract transcript from your API response structure
        if (!transcribeData.results || transcribeData.results.length === 0) {
          throw new Error('No transcription results returned');
        }

        const firstResult = transcribeData.results[0];
        let transcript = '';

        // Try different possible locations for the transcript
        if (firstResult.transcription) {
          if (typeof firstResult.transcription === 'string') {
            transcript = firstResult.transcription;
          } else if (firstResult.transcription.transcript) {
            transcript = firstResult.transcription.transcript;
          } else if (firstResult.transcription.text) {
            transcript = firstResult.transcription.text;
          } else {
            // If it's an object, try to extract text from it
            transcript = JSON.stringify(firstResult.transcription);
          }
        }

        if (!transcript || transcript.length < 10) {
          throw new Error('Invalid or empty transcript received');
        }

        status.textContent = 'Analyzing with AI...';

        // Enhanced prompt for detailed analysis
        const prompt = `Analyze this sales call transcript and rate the speaker on a scale of 0-20 for each category. For clarity analysis, provide specific examples from the transcript with detailed breakdown. Return ONLY valid JSON in this exact format:

{
  "engagement": {
    "score": 15, 
    "comment": "comment at least 3 lines in hinglish",
    "detailed_analysis": []
  },
  "clarity": {
    "score": 18, 
    "comment": "comment at least 3 lines in hinglish",
    "detailed_analysis": [
      {
        "category": "Technical Terms",
        "original": "exact quote from transcript where technical terms were used",
        "issue": "what's wrong with how it was said",
        "suggestion": "how it could be better explained in hinglish"
      },
      {
        "category": "Course Benefits", 
        "original": "exact quote about course benefits",
        "issue": "what's unclear about the statement",
        "suggestion": "clearer way to explain the benefits"
      },
      {
        "category": "Job Opportunities",
        "original": "exact quote about job prospects", 
        "issue": "what's vague about the statement",
        "suggestion": "more specific way to explain job opportunities"
      }
    ]
  },
  "product_knowledge": {
    "score": 12, 
    "comment": "comment at least 3 lines in hinglish",
    "detailed_analysis": []
  },
  "listening_skills": {
    "score": 16, 
    "comment": "comment at least 3 lines in hinglish", 
    "detailed_analysis": []
  },
  "handling_objections": {
    "score": 14, 
    "comment": "comment at least 3 lines in hinglish",
    "detailed_analysis": []
  },
  "closing_techniques": {
    "score": 13, 
    "comment": "comment at least 3 lines in hinglish",
    "detailed_analysis": []
  }
}

For clarity analysis, identify at least 3-5 specific instances where the speaker could have been clearer. Focus on:
1. Technical terms that weren't explained properly
2. Vague statements about course benefits
3. Unclear job opportunity descriptions
4. Course structure explanations that lacked context
5. Internship/placement information that was confusing

Each detailed_analysis item should have exact quotes from the transcript.

Transcript: ${transcript.substring(0, 3000)}`;

        const geminiRes = await fetch(GEMINI_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        });

        if (!geminiRes.ok) {
          throw new Error(`Gemini API failed: ${geminiRes.status}`);
        }
        
        const geminiJson = await geminiRes.json();
        let content = geminiJson.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!content) {
          throw new Error('No response from Gemini');
        }

        // Clean up the response and parse JSON
        content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const analysis = JSON.parse(content);

        // Save to database
        status.textContent = 'Saving results to database...';
        await saveToDatabase(audioUrl, transcript, analysis);

        showResults(analysis);

      } catch (err) {
        console.error('Full error:', err);
        showError(`Error: ${err.message}`);
      }
    };

    async function saveToDatabase(audioUrl, transcript, analysis) {
        try {
            const saveData = {
            cs_id: 2,
            audiolink: audioUrl,
            file_url: audioUrl,
            transcription: transcript,
            call_opening: analysis.engagement || {},
            speech_clarity: analysis.clarity || {},
            product_knowledge: analysis.product_knowledge || {},
            call_control: analysis.listening_skills || {},
            communication_skill: analysis.handling_objections || {},
            closing_skill: analysis.closing_techniques || {},
            status: 'COMPLETED'
            };

            const saveRes = await fetch(SAVE_DB_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(saveData)
            });

            if (!saveRes.ok) {
            console.error('Failed to save to database:', saveRes.status);
            } else {
            console.log('Successfully saved to database');
            }
        } catch (err) {
            console.error('Error saving to database:', err);
        }
    }

    function renderDetailedAnalysis(detailedAnalysis) {
      if (!detailedAnalysis || detailedAnalysis.length === 0) {
        return '';
      }
      
      return detailedAnalysis.map(item => `
        <div class="analysis-section">
          <h4>${item.category}:</h4>
          <div class="analysis-content">
            <div class="original-text"><strong>Original:</strong> "${item.original}"</div>
            <div class="issue-text"><strong>Issue:</strong> ${item.issue}</div>
            <div class="suggestion-text"><strong>Suggestion:</strong> ${item.suggestion}</div>
          </div>
        </div>
      `).join('');
    }

    function showResults(data) {
      spinner.style.display = 'none';
      status.textContent = '';
      results.style.display = 'block';
      analyzeBtn.textContent = 'Analyze';
      analyzeBtn.disabled = false;

      const keys = Object.keys(data);
      const scores = keys.map(k => data[k]?.score || 0);
      const avg = Math.round(scores.reduce((a, b) => a + b, 0) / keys.length);

      overall.textContent = `Overall Score: ${avg}/20`;

      // Function to get score class based on score value
      function getScoreClass(score) {
        if (score >= 15) return 'score-high';
        if (score >= 10) return 'score-medium';
        return 'score-low';
      }

      // Create table with results
      scoreCards.innerHTML = `
        <table class="results-table">
          <thead>
            <tr>
              <th>Category</th>
              <th>Score</th>
              <th>Comments & Analysis</th>
            </tr>
          </thead>
          <tbody>
            ${keys.map(k => {
              const title = k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
              const score = data[k]?.score || 0;
              const comment = data[k]?.comment || 'No comment';
              const detailedAnalysis = data[k]?.detailed_analysis || [];
              const scoreClass = getScoreClass(score);
              
              return `
                <tr>
                  <td class="category-cell">${title}</td>
                  <td class="score-cell ${scoreClass}">${score}/20</td>
                  <td class="comment-cell">
                    <div>${comment}</div>
                    ${detailedAnalysis.length > 0 ? `
                      <div class="detailed-analysis">
                        ${renderDetailedAnalysis(detailedAnalysis)}
                      </div>
                    ` : ''}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    resetBtn.onclick = () => {
      // Don't clear URL if it came from parameter
      const audiolink = getUrlParameter('audiolink');
      if (!audiolink) {
        urlInput.value = '';
        urlInfo.style.display = 'none';
        analyzeBtn.disabled = true;
      }
      
      spinner.style.display = 'none';
      status.textContent = '';
      results.style.display = 'none';
      scoreCards.innerHTML = '';
      overall.textContent = '';
      hideError();
    };
  </script>

</body>
</html>
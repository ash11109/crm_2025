<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sales Call Analyzer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 30px;
      background: #f9f9f9;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      font-size: 16px;
    }
    .url-input-container {
      margin: 20px 0;
    }
    .url-input {
      width: 100%;
      max-width: 600px;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    .url-info {
      margin: 10px 0;
      padding: 10px;
      background: #e9ecef;
      border-radius: 5px;
      font-size: 14px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      margin: 20px auto;
      border: 4px solid #ccc;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .score {
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fff;
      padding: 15px;
      margin: 10px 0;
    }
    .score h3 {
      margin: 0 0 5px;
      font-size: 18px;
    }
    .score p {
      margin: 0;
    }
    #overall {
      font-weight: bold;
      font-size: 20px;
      margin: 20px 0 10px;
    }
    #results {
      margin-top: 30px;
    }
    .error {
      color: #dc3545;
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      white-space: pre-wrap;
    }
    .success {
      color: #155724;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .debug {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .auto-detected {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
  </style>
</head>
<body>

  <h1>Sales Call Analyzer</h1>
  <p>Enter an audio URL or use the URL parameter to analyze speaker performance using AI.</p>
  
  <div class="url-input-container">
    <input type="url" id="urlInput" class="url-input" placeholder="Enter audio file URL here..." />
    <div id="urlInfo" class="url-info" style="display: none;"></div>
  </div>
  
  <button id="analyzeBtn" disabled>Analyze</button>

  <div id="spinner" class="spinner" style="display: none;"></div>
  <div id="status"></div>
  <div id="errorMessage" class="error" style="display: none;"></div>
  <div id="debugInfo" class="debug" style="display: none;"></div>

  <div id="results" style="display: none;">
    <div id="overall"></div>
    <div id="scoreCards"></div>
    <button id="resetBtn">Analyze Another Call</button>
  </div>

  <script>
    const TRANSCRIBE_URL = 'https://sttsarvam.onrender.com/transcribe/urls';
    const GEMINI_API_KEY = 'AIzaSyBDHAtCgKffA2YurDUpwkH-Nvr19HJF3DQ';
    const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
    const CHECK_DB_URL = 'https://teamka.in/z_ash_test/fetch_status.php';
    const SAVE_DB_URL = 'https://teamka.in/z_ash_test/save_qa.php';

    const urlInput = document.getElementById('urlInput');
    const urlInfo = document.getElementById('urlInfo');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const spinner = document.getElementById('spinner');
    const status = document.getElementById('status');
    const errorMessage = document.getElementById('errorMessage');
    const debugInfo = document.getElementById('debugInfo');
    const results = document.getElementById('results');
    const overall = document.getElementById('overall');
    const scoreCards = document.getElementById('scoreCards');
    const resetBtn = document.getElementById('resetBtn');

    // Check for audiolink parameter in URL
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Initialize with URL parameter or localStorage if present
    window.addEventListener('load', function() {
      let audiolink = getUrlParameter('audiolink');
      let type = getUrlParameter('type');
      let id = getUrlParameter('id');
      let source = 'URL parameter';
      
      // Fallback to localStorage if no URL parameter
      if (!audiolink && localStorage.getItem('AI_QA_link')) {
        audiolink = localStorage.getItem('AI_QA_link');
        type = localStorage.getItem('AI_QA_Intrested_IN');
        id = localStorage.getItem('AI_QA_CS_ID');
        source = 'localStorage';
      }
      
      if (audiolink) {
        urlInput.value = audiolink;
        
        let infoHtml = `
          <strong>Auto-detected URL:</strong> ${audiolink}<br>
          <strong>Source:</strong> ${source}
        `;
        
        if (type) infoHtml += `<br><strong>Type:</strong> ${type}`;
        if (id) infoHtml += `<br><strong>ID:</strong> ${id}`;
        
        urlInfo.innerHTML = infoHtml;
        urlInfo.className = 'url-info auto-detected';
        urlInfo.style.display = 'block';
        analyzeBtn.disabled = false;
        
        // Store these values for later use in analysis
        window.qaData = { audiolink, type, id };
      }
    });

    // URL input handler
    urlInput.addEventListener('input', function(e) {
      const url = e.target.value.trim();
      if (url && isValidUrl(url)) {
        urlInfo.innerHTML = `
          <strong>Audio URL:</strong> ${url}<br>
          <strong>Status:</strong> Ready to analyze
        `;
        urlInfo.className = 'url-info';
        urlInfo.style.display = 'block';
        analyzeBtn.disabled = false;
      } else if (url) {
        urlInfo.innerHTML = `
          <strong>Invalid URL:</strong> Please enter a valid audio file URL
        `;
        urlInfo.className = 'url-info error';
        urlInfo.style.display = 'block';
        analyzeBtn.disabled = true;
      } else {
        urlInfo.style.display = 'none';
        analyzeBtn.disabled = true;
      }
    });

    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      spinner.style.display = 'none';
      status.textContent = '';
    }

    function showDebug(info) {
      debugInfo.textContent = JSON.stringify(info, null, 2);
      debugInfo.style.display = 'block';
    }

    function hideError() {
      errorMessage.style.display = 'none';
      debugInfo.style.display = 'none';
    }

    analyzeBtn.onclick = async () => {
      const audioUrl = urlInput.value.trim();
      if (!audioUrl || !isValidUrl(audioUrl)) {
        showError('Please enter a valid audio URL first.');
        return;
      }

      hideError();
      spinner.style.display = 'block';
      status.textContent = 'Checking database for existing analysis...';
      results.style.display = 'none';

      try {
        // First, check if analysis already exists in database
        function parseSafe(jsonString) {
            try {
                const obj = JSON.parse(jsonString);
                if (typeof obj === 'object' && obj !== null && 'score' in obj) {
                return obj;
                }
                return { score: 0, comment: 'Invalid format' };
            } catch {
                return { score: 0, comment: 'Not JSON' };
            }
        }

        const checkRes = await fetch(`${CHECK_DB_URL}?audiolink=${encodeURIComponent(audioUrl)}`);
        
        if (!checkRes.ok) {
          throw new Error(`Database check failed: ${checkRes.status}`);
        }

        const checkData = await checkRes.text();
        console.log('Database check response:', checkData);

        // If response is "PENDING", show pending message
        if (checkData.trim() === '"PENDING"' || checkData.trim() === 'PENDING') {
        // No record in DB â€” proceed with transcription + analysis
        console.log('No record found in DB, proceeding with transcription...');
        } else {
        // Try to parse as existing result
        let existingData;
        try {
            existingData = JSON.parse(checkData);
        } catch (e) {
            existingData = null;
        }

        if (existingData && Array.isArray(existingData) && existingData.length > 0 && existingData[0].Status !== 'PENDING') {
            status.textContent = 'Found existing analysis in database!';
            const dbRecord = existingData[0];
            
            const analysisData = {
                engagement: parseSafe(dbRecord.Call_Opening),
                clarity: parseSafe(dbRecord.Speech_Clarity),
                product_knowledge: parseSafe(dbRecord.Product_Knowledge),
                listening_skills: parseSafe(dbRecord.Call_Control),
                handling_objections: parseSafe(dbRecord.Communication_Skill),
                closing_techniques: parseSafe(dbRecord.Closing_Skill)
            };

            
            showResults(analysisData);
            return;
        }
        }


        // Try to parse as JSON (existing completed analysis)
        let existingData;
        try {
          existingData = JSON.parse(checkData);
        } catch (e) {
          existingData = null;
        }

        // If we have existing completed data, use it
        if (existingData && Array.isArray(existingData) && existingData.length > 0 && existingData[0].Status !== 'PENDING') {
          status.textContent = 'Found existing analysis in database!';
          const dbRecord = existingData[0];
          
          // Convert database format to our analysis format
          const analysisData = {
            engagement: parseSafe(dbRecord.Call_Opening),
            clarity: parseSafe(dbRecord.Speech_Clarity),
            product_knowledge: parseSafe(dbRecord.Product_Knowledge),
            listening_skills: parseSafe(dbRecord.Call_Control),
            handling_objections: parseSafe(dbRecord.Communication_Skill),
            closing_techniques: parseSafe(dbRecord.Closing_Skill)
        };

          
          showResults(analysisData);
          return;
        }

        // No existing data, proceed with API calls
        status.textContent = 'No existing analysis found. Starting transcription...';
        
        // Send URL to transcription service
        const requestBody = {
          file_urls: [audioUrl]
        };

        console.log('Sending to:', TRANSCRIBE_URL);
        console.log('Request body:', requestBody);

        const transcribeRes = await fetch(TRANSCRIBE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        console.log('Response status:', transcribeRes.status);
        
        if (!transcribeRes.ok) {
          const errorText = await transcribeRes.text();
          console.error('Error response:', errorText);
          throw new Error(`Server error ${transcribeRes.status}: ${errorText}`);
        }

        status.textContent = 'Processing transcription...';
        const transcribeData = await transcribeRes.json();
        console.log('Transcription response:', transcribeData);
        showDebug(transcribeData);

        // Extract transcript from your API response structure
        if (!transcribeData.results || transcribeData.results.length === 0) {
          throw new Error('No transcription results returned');
        }

        const firstResult = transcribeData.results[0];
        let transcript = '';

        // Try different possible locations for the transcript
        if (firstResult.transcription) {
          if (typeof firstResult.transcription === 'string') {
            transcript = firstResult.transcription;
          } else if (firstResult.transcription.transcript) {
            transcript = firstResult.transcription.transcript;
          } else if (firstResult.transcription.text) {
            transcript = firstResult.transcription.text;
          } else {
            // If it's an object, try to extract text from it
            transcript = JSON.stringify(firstResult.transcription);
          }
        }

        if (!transcript || transcript.length < 10) {
          throw new Error('Invalid or empty transcript received');
        }

        status.textContent = 'Analyzing with AI...';

        // Simple prompt for Gemini
        const prompt = `Analyze this sales call transcript and rate the speaker on a scale of 0-20 for each category. Return ONLY valid JSON:

{
  "engagement": {"score": 15, "comment": "Brief comment"},
  "clarity": {"score": 18, "comment": "Brief comment"}, 
  "product_knowledge": {"score": 12, "comment": "Brief comment"},
  "listening_skills": {"score": 16, "comment": "Brief comment"},
  "handling_objections": {"score": 14, "comment": "Brief comment"},
  "closing_techniques": {"score": 13, "comment": "Brief comment"}
}

Transcript: ${transcript.substring(0, 2000)}`;

        const geminiRes = await fetch(GEMINI_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        });

        if (!geminiRes.ok) {
          throw new Error(`Gemini API failed: ${geminiRes.status}`);
        }
        
        const geminiJson = await geminiRes.json();
        let content = geminiJson.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!content) {
          throw new Error('No response from Gemini');
        }

        // Clean up the response and parse JSON
        content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const analysis = JSON.parse(content);

        // Save to database
        status.textContent = 'Saving results to database...';
        await saveToDatabase(audioUrl, transcript, analysis);

        showResults(analysis);

      } catch (err) {
        console.error('Full error:', err);
        showError(`Error: ${err.message}`);
      }
    };

    async function saveToDatabase(audioUrl, transcript, analysis) {
        try {
            const saveData = {
            audiolink: audioUrl,
            transcription: transcript,
            call_opening: analysis.engagement || {},
            speech_clarity: analysis.clarity || {},
            product_knowledge: analysis.product_knowledge || {},
            call_control: analysis.listening_skills || {},
            communication_skill: analysis.handling_objections || {},
            closing_skill: analysis.closing_techniques || {},
            status: 'COMPLETED'
            };

            const saveRes = await fetch(SAVE_DB_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(saveData)
            });

            if (!saveRes.ok) {
            console.error('Failed to save to database:', saveRes.status);
            } else {
            console.log('Successfully saved to database');
            }
        } catch (err) {
            console.error('Error saving to database:', err);
        }
    }


    function showResults(data) {
      spinner.style.display = 'none';
      status.textContent = '';
      results.style.display = 'block';

      const keys = Object.keys(data);
      const scores = keys.map(k => data[k]?.score || 0);
      const avg = Math.round(scores.reduce((a, b) => a + b, 0) / keys.length);

      overall.textContent = `Overall Score: ${avg}/20`;

      scoreCards.innerHTML = keys.map(k => {
        const title = k.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        return `
          <div class="score">
            <h3>${title}: ${data[k]?.score || 0}/20</h3>
            <p>${data[k]?.comment || 'No comment'}</p>
          </div>
        `;
      }).join('');
    }

    resetBtn.onclick = () => {
      // Don't clear URL if it came from parameter
      const audiolink = getUrlParameter('audiolink');
      if (!audiolink) {
        urlInput.value = '';
        urlInfo.style.display = 'none';
        analyzeBtn.disabled = true;
      }
      
      spinner.style.display = 'none';
      status.textContent = '';
      results.style.display = 'none';
      scoreCards.innerHTML = '';
      overall.textContent = '';
      hideError();
    };
  </script>

</body>
</html>